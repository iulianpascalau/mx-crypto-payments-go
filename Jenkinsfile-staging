pipeline {
    agent any

    parameters {
        string(name: 'BRANCH_OR_TAG', defaultValue: 'main', description: 'Branch or Tag to deploy (e.g., main, v1.0.0)')
    }

    environment {
        STAGING_VM_USER = 'ubuntu'
        // You will need to add this credential in Jenkins
        STAGING_VM_HOST = credentials('crypto-payment-staging-vm-ip')
        PROJECT_PATH = '/home/ubuntu/mx-crypto-payments-go'
    }

    stages {
        stage('Deploy') {
            steps {
                sshagent(['prod-vm-ssh-key']) {
                     sh "ssh -o StrictHostKeyChecking=no ${STAGING_VM_USER}@${STAGING_VM_HOST} 'cd ${PROJECT_PATH} && ./scripts/deploy.sh ${params.BRANCH_OR_TAG}'"
                }
            }
        }
    }
}
